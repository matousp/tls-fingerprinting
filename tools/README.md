# Tools

This folder contains scripts for TLS fingerprinting using JA4 and JA34 hashes. The method was originally developped by John Althouse and others, see https://blog.foxio.io/ja4+-network-fingerprinting. The following scripts process PCAP files, extract TLS features, and calculate JA4 and JA4S hashes. They also create a record of TLS attributes for each TLS connection, which can be used to identify encrypted applications. 

(c) Petr Matousek, 2024 <br>
Contact: matousp@fit.vutbr.cz

This work is supported by the project [Flow-based Encrypted Traffic Analysis (FETA)](https://www.fit.vut.cz/research/project/1530/.en), 2022-2025, no.
VJ02010024, funded by the Ministry of the Interior of the Czech Republic, and the internal BUT project [Smart Information Technology for a Resilient Society](https://www.fit.vut.cz/research/project/1731/.en), 2023-2025, no. FIT-S-23-8209. 

When using these scripts and the provided datasets, please refer to the paper *Matoušek Petr, Ryšavý Ondřej a Burgetová Ivana. Experience Report: Using JA4+ Fingerprints for Malware Detection in Encrypted Traffic. In the Proceedings of the 20th International Conference on Network and Service Management, Prague, Czech Republic, 2024*.

A list of scripts:
  - `get-ja4.sh` - extracts TLS data from a PCAP file and creates JA3, JA3S, JA4 and JA4S fingerprints
  - `tls2ja4.pl` - a parser that reads the CSV output of tshark, processes TLS handshakes and computes TLS fingerprints
  - `get-whois.pl` - a script that resolves given IP addresses using WHOIS service

## Installation
All scripts have been developed and used on the FreeBSD system. They can also run on any Linux or MS Window system. The following software should be installed to run properly the scripts:
  * `tshark, version 4.4.0`
  * `perl 5, version 36`
  * Required perl modules: `Digest::MD5, Digest::SHA, Getopt::Long, IO::Handle, Net::Whois::IP`

## User Guide
### 1. Extracting JA3, JA3S, JA4, and JA4S hashes from a PCAP file

`Format: get-ja4.sh <PCAP>  [-a <AppName>] [-v <version>] [-t <0 | M | A>] [-d <output dir>] [-w <whois file>]`
 
Example: `./get-ja4.sh aliexpress.pcap -a aliexpress-t M -w whois.txt`
  
 - The script reads a PCAP file with captured communication, extracts selected fields from TLS handshakes (incl. QUIC), and creates JA3, JA3S, JA4 and JA4S hashes. 
 - Extracted domain names are labeled with A type if a domain name is part of advertising or tracking servers. A list of these servers is locally stored in <tt>ad-list.txt</tt> file. The file is a compilation of public sources:
    * <https://pgl.yoyo.org/adservers/serverlist.php?hostformat=hosts&showintro=1&mimetype=plaintext&_=3>
    * <https://github.com/fredprod/host-file.net-backup/blob/master/ad_servers.txt>
    * <https://gitlab.com/morganas/dbl-oisd-nl/-/raw/master/dbl.txt>
    * <https://raw.githubusercontent.com/lightswitch05/hosts/refs/heads/master/docs/lists/ads-and-tracking-extended.txt>
    * <https://easylist.to/easylist/easyprivacy.txt>
    * and others :)

 - `whois file` is a list of CSV entries in format <IP address>;<OrgName> generated by get-whois.pl.

 The following data is extracted from the PCAP file:
  * From TLS handshakes: src IP, dst IP, src port, dst port, TLS handshake type, TLS handshake version, TLS ciphersuite, TLS extension, TLS handshake SNI, TLS supported groups, TLS EC point format, TLS extension ALPN, TLS extension signature algorithms, TLS extension supported versions, frame time
  
The following output files will be created for each input file if they do not exist:
  * `<filename>-exported.csv` - TLS fields in CSV format extracted from TLS handshakes (client and server Hello packets).
  * `<filename>-ja4.csv` - computed TLS fingerprints with selected TLS fields and annotation.
  * `<filename>-ja4-raw.csv` - a full output of TLS processing with TLS fingerprint hashes, selected TLS fields, and a raw format of the fingerprints before hashing
  
The `get-ja4.sh` script also calls a Perl script `tls2ja4.pl` to analyze an extracted CSV file `<filename>-exported.csv`.
  
### 2. Processing TLS data

TLS data in CSV format extracted directly from PCAP file with TLS communication is processed by the `tls2ja4.pl` parser, which reads a CSV output from the `tshark`, processes TLS handshakes and computes JA3, JA3S, JA4 and JA4S hashes. 

Format: `tls2ja4.pl -f <input.csv> [-short] [-app AppName] [-ver Version] [-type <0|A|M>] [-res <resolution.csv>] [-whois <whois.csv>]`
 
Parameters:
  * `<input.csv>`: is expected to be tshark output: 
        `tshark -r <PCAP file> -T fields -E separator=";" -e ip.src -e ip.dst -e tcp.srcport -e tcp.dstport
       -e udp.srcport -e udp.dstport -e ip.proto -e tls.handshake.type -e tls.handshake.version
       -e tls.handshake.ciphersuite -e tls.handshake.extension.type -e tls.handshake.extensions_server_name
       -e tls.handshake.extensions_supported_group -e tls.handshake.extensions_ec_point_format
       -e tls.handshake.extensions_alpn_str -e tls.handshake.sig_hash_alg
       -e tls.handshake.extensions.supported_version -e frame.time
       -R "ssl.handshake.type==1 or ssl.handshake.type==2" -2`
  * `-short`: prints a simple output: srcIP;dstIP;srcPort;dstPort;SNI;Orgname;JA3 hash;JA4 hash; Application Name; Type; JA3s hash; JA4s hash;filename;Version
    * Without this parameter, it prints the full (raw) output is printed with the following items: SrcIP; DstIP; SrcPort; DstPort; Proto; SNI; OrgName; TLS Version; Client CipherSuite; Client Extensions; Client Supported Groups; EC_fmt; ALPN; Signature Algorithms; Client SuppVers; JA3hash; JA4; JA4_r; Application Name; Type; Server CipherSuite; Server Extensions; Server SuppVers;JA3S hash; JA4S hash;JA4S_r hash;filename;Version
  * `-app AppName`: the name of the application that will be assigned to all TLS connections in the file,
  * `-ver Version`: the version of the application to be associated with all TLS connections in the file (currently not used).
  * `-type <0 | A | M>`: a tag indicating whether the TLS connection is a normal application (0), malware (M), or an advertising/tracking server (A).
  * `-res <resolution.csv`: an optional file that maps TLS handshakes to applications based on the source port number.
    * CSV format is expected: <local port>,<process name>
    * If the file is available, the process name will be assigned to a TLS communication with the given local port. 
  * `-whois <whois.csv>`: an optional file that maps the destination IP address (from the Client Hello) to a WHOIS Organization Name.
    * If the IP address is not found in the file, empty string is assigned.
    * Required `whois.csv` format: <dst IPv4 address>,<whois org name>, see below. 

Examples: 
  * tls2ja4.pl -f aliexpress -extracted.csv -app aliexpress -type M -whois whois.txt
    
### Output example:
* Full output, e.g., aliexpress-ja4-raw.csv:
```
SrcIP;DstIP;SrcPort;DstPort;Proto;SNI;OrgName;TLS Version;Client CipherSuite;Client Extensions;Client Supported Groups;EC_fmt;ALPN;Signature Algorithms;Client Supported Versions;JA3hash;JA4 hash;JA4_raw;AppName;Type;Server CipherSuite;Server Extensions;Server Supported Versions;JA3S hash;JA4S hash;JA4S_raw;Filename;Version
192.168.3.28;104.96.145.31;64877;443;6;www.aliexpress.com;Akamai International, BV, AIBV;771;4865-4866-4867-49195-49199-49196-49200-52393-52392-49171-49172-156-157-47-53;0-23-65281-10-11-35-16-5-13-18-51-45-43-27-17513-21;0x8a8a,0x001d,0x0017,0x0018;0;h2,http/1.1;0403,0804,0401,0503,0805,0501,0806,0601;0x9a9a,0x0304,0x0303,0x0302,0x0301;cd08e31494f9531f560d64c695473da9;t13d1516h2_8daaf6152771_e5627efa2ab1;t13d1516h2_002f,0035,009c,009d,1301,1302,1303,c013,c014,c02b,c02c,c02f,c030,cca8,cca9_0005,000a,000b,000d,0012,0015,0017,001b,0023,002b,002d,0033,4469,ff01_0403,0804,0401,0503,0805,0501,0806,0601;aliexpress;0;49196;65281-0-11-35-5-16;;42ec7b1db61428bf1cc6e01b9ef02b04;t1206h2_c02c_e1dda4771ae8;t1206h2_c02c_ff01,000b,0023,0005;tests/apps3/aliexpress_01-11-extracted.csv;0
192.168.3.28;104.96.145.31;64878;443;6;www.aliexpress.com;Akamai International, BV, AIBV;771;4865-4866-4867-49195-49199-49196-49200-52393-52392-49171-49172-156-157-47-53;0-23-65281-10-11-35-16-5-13-18-51-45-43-27-17513-21;0x8a8a,0x001d,0x0017,0x0018;0;h2,http/1.1;0403,0804,0401,0503,0805,0501,0806,0601;0x1a1a,0x0304,0x0303,0x0302,0x0301;cd08e31494f9531f560d64c695473da9;t13d1516h2_8daaf6152771_e5627efa2ab1;t13d1516h2_002f,0035,009c,009d,1301,1302,1303,c013,c014,c02b,c02c,c02f,c030,cca8,cca9_0005,000a,000b,000d,0012,0015,0017,001b,0023,002b,002d,0033,4469,ff01_0403,0804,0401,0503,0805,0501,0806,0601;aliexpress;0;49196;65281-0-11-35-5-16;;42ec7b1db61428bf1cc6e01b9ef02b04;t1206h2_c02c_e1dda4771ae8;t1206h2_c02c_ff01,000b,0023,0005;tests/apps3/aliexpress_01-11-extracted.csv;0
192.168.3.28;104.96.145.31;64923;443;6;assets.alicdn.com;Akamai International, BV, AIBV;771;4865-4866-4867-49195-49199-49196-49200-52393-52392-49171-49172-156-157-47-53;0-23-65281-10-11-35-16-5-13-18-51-45-43-27-17513-21;0xbaba,0x001d,0x0017,0x0018;0;h2,http/1.1;0403,0804,0401,0503,0805,0501,0806,0601;0x3a3a,0x0304,0x0303,0x0302,0x0301;cd08e31494f9531f560d64c695473da9;t13d1516h2_8daaf6152771_e5627efa2ab1;t13d1516h2_002f,0035,009c,009d,1301,1302,1303,c013,c014,c02b,c02c,c02f,c030,cca8,cca9_0005,000a,000b,000d,0012,0015,0017,001b,0023,002b,002d,0033,4469,ff01_0403,0804,0401,0503,0805,0501,0806,0601;aliexpress;0;49196;65281-0-11-35-5-16;;42ec7b1db61428bf1cc6e01b9ef02b04;t1206h2_c02c_e1dda4771ae8;t1206h2_c02c_ff01,000b,0023,0005;tests/apps3/aliexpress_01-11-extracted.csv;0
```
* Short output, e.g., aliexpress-ja4.csv
```
SrcIP;DstIP;SrcPort;DstPort;SNI;OrgName;JA3hash;JA4 hash;AppName;Type;JA3S hash;JA4S hash;Filename;Version
192.168.3.28;104.96.145.31;64877;443;www.aliexpress.com;Akamai International, BV, AIBV;cd08e31494f9531f560d64c695473da9;t13d1516h2_8daaf6152771_e5627efa2ab1;aliexpress;0;42ec7b1db61428bf1cc6e01b9ef02b04;t1206h2_c02c_e1dda4771ae8;tests/apps3/aliexpress_01-11-extracted.csv;0
192.168.3.28;104.96.145.31;64878;443;www.aliexpress.com;Akamai International, BV, AIBV;cd08e31494f9531f560d64c695473da9;t13d1516h2_8daaf6152771_e5627efa2ab1;aliexpress;0;42ec7b1db61428bf1cc6e01b9ef02b04;t1206h2_c02c_e1dda4771ae8;tests/apps3/aliexpress_01-11-extracted.csv;0
192.168.3.28;104.96.145.31;64923;443;assets.alicdn.com;Akamai International, BV, AIBV;cd08e31494f9531f560d64c695473da9;t13d1516h2_8daaf6152771_e5627efa2ab1;aliexpress;0;42ec7b1db61428bf1cc6e01b9ef02b04;t1206h2_c02c_e1dda4771ae8;tests/apps3/aliexpress_01-11-extracted.csv;0
```
### 3. IP address resolution using the WHOIS database

TLS records can be extended with the Organization Name obtained from the WHOIS database. Due to the long response time for online processing, it is recommended to resolve IP addresses to OrgNames offline using the Whois database. For this purpose, it is possible to use the `get-whois.pl` script, which reads a list of IP addresses and maps them toOrgNames. 

Format: `get-whois.pl -f <input_file> -out <output_file>`
 
Parameters:
  * `<input_file>`: a list of IPv4 addresses, each address is on a separate line. 
  * `<output_file>`: a CSV file of resolved IPv4 addresses and owner description retreived from the WHOIS database.
    * Output file in CSV format: `<IPv4 address>;<owner description>`

  The organization name is not always available in the WHOIS database, so the following WHOIS fields are queried and processed to get the response: orgname, organization, role, desc, netname
     
Example: 
  * `./get-whois.pl -f ip-list.txt -out whois.txt`
    
  * Example of an input file:
```
1.0.0.1
1.1.1.1
1.194.172.138
1.51.6.3
100.20.15.103
100.20.16.155
100.20.20.131
100.21.153.152
100.21.156.86
```
* Example of an output file:
```
1.0.0.1;APNIC Research and Development, APNIC-LABS (AU)
1.1.1.1;APNIC Research and Development, IDNIC-BOYOLALIKAB-ID (ID)
1.194.172.138;ABUSE CHINANETCN, CHINANET-HA (CN)
1.51.6.3;CERNET Helpdesk, NJR-CERNET (CN)
100.20.15.103;Amazon.com, Inc., AMAZO-4
100.20.16.155;Amazon.com, Inc., AMAZO-4
100.20.20.131;Amazon.com, Inc., AMAZO-4
100.21.153.152;Amazon.com, Inc., AMAZO-4
100.21.156.86;Amazon.com, Inc., AMAZO-4
```

## References
  1. Matoušek Petr, Ryšavý Ondřej a Burgetová Ivana. Towards Identification of Network Applications in Encrypted Traffic. In the Proceedings of the 8th Cyber Security in Networking Conference 2024, Paris, France, 2024, p. 1-9.
  2. MATOUŠEK Petr, RYŠAVÝ Ondřej a BURGETOVÁ Ivana. Experience Report: Using JA4+ Fingerprints for Malware Detection in Encrypted Traffic. In: Proceedings of 20th International Conference on Network and Service Management. Prague, 2024, p. 1-5.
  3. MATOUŠEK Petr, BURGETOVÁ Ivana and VICTOR Malombe. Mobile Device Fingerprinting. FIT-TR-2020-05, Brno, 2020. Document available at https://www.fit.vut.cz/research/publication/12313/.en.
  4. MATOUŠEK Petr. Detekce mobilních zařízení v síťové komunikaci. FIT-TR-2017-08, Brno. Document available at https://www.fit.vut.cz/research/publication/12309/.cs (in Czech only).


## Licence
This software can be freely used under BUT open software licence:
<h3>BUT OPEN SOURCE LICENCE</h3>
Version 1.
Copyright (c) 2017, Brno University of Technology, Antonínská 548/1, 601 90, Czech Republic

BY INSTALLING, COPYING OR OTHER USES OF SOFTWARE YOU ARE DECLARING THAT YOU AGREE WITH THE TERMS AND CONDITIONS OF THIS LICENCE AGREEMENT. IF YOU DO NOT AGREE WITH THE TERMS AND CONDITIONS, DO NOT INSTAL, COPY OR USE THE SOFTWARE.
IF YOU DO NOT POSESS A VALID LICENCE, YOU ARE NOT AUTHORISED TO INSTAL, COPY OR OTHERWISE USE THE SOTWARE.

Definitions:
For the purpose of this agreement, Software shall mean a computer program (a group of computer programs functional as a unit) capable of copyright protection and accompanying documentation.

Work based on Software shall mean a work containing Software or a portion of it, either verbatim or with modifications and/or translated into another language, or a work based on Software. Portions of work not containing a portion of Software or not based on Software are not covered by this definition, if it is capable of independent use and distributed separately.
Source code shall mean all the source code for all modules of Software, plus any associated interface definition files, plus the scripts used to control compilation and installation of the executable program. Source code distributed with Software need not include anything that is normally distributed (in either source or binary form) with the major components (compiler, kernel, and so on) of the operating system on which the executable program runs.

Anyone who uses Software becomes User. User shall abide by this licence agreement.

BRNO UNIVERSITY OF TECHNOLOGY GRANTS TO USER A LICENCE TO USE SOFTWARE ON THE FOLLOWING TERMS AND CONDITIONS:
* User may use Software for any purpose, commercial or non-commercial, without a need to pay any licence fee.
* User may copy and distribute verbatim copies of executable Software with source code as he/she received it, in any medium, provided that User conspicuously and appropriately publishes on each copy an appropriate copyright notice and disclaimer of warranty; keeps intact all the notices that refer to this licence and to the absence of any warranty; and give any other recipients of Software a copy of this licence along with Software. User may charge a fee for the physical act of transferring a copy, and may offer warranty protection in exchange for a fee.
* User may modify his/her copy or copies of Software or any portion of it, thus forming a work based on Software, and copy and distribute such modifications or work, provided that User clearly states this work is modified Software. These modifications or work based on software may be distributed only under the terms of section 2 of this licence agreement, regardless if it is distributed alone or together with other work. Previous sentence does not apply to mere aggregation of another work not based on software with Software (or with a work based on software) on a volume of a storage or distribution medium.
* User shall accompany copies of Software or work based on software in object or executable form with:
a) the complete corresponding machine-readable source code, which must be distributed on a medium customarily used for software interchange; or,
b) written offer, valid for at least three years, to give any third party, for a charge no more than actual cost of physically performing source distribution, a complete machine-readable copy of the corresponding source code, to be distributed on a medium customarily used for software interchange; or,
c) the information User received as to the offer to distribute corresponding source code. (This alternative is allowed only for noncommercial distribution and only if User received the program in objects code or executable form with such an offer, in accord with subsection b above.)
* User may not copy, modify, grant sublicences or distribute Software in any other way than expressly provided for in this licence agreement. Any other copying, modifying, granting of sublicences or distribution of Software is illegal and will automatically result in termination of the rights granted by this licence. This does not affect rights of third parties acquired in good faith, as long as they abide by the terms and conditions of this licence agreement.
* User may not use and/or distribute Software, if he/she cannot satisfy simultaneously obligations under this licence and any other pertinent obligations.
* User is not responsible for enforcing terms of this agreement by third parties.

BECAUSE SOFTWARE IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY FOR SOFTWARE, TO THE EXTENT PERMITTED BY APPLICABLE LAW. EXCEPT WHEN OTHERWISE STATED IN WRITING, BUT PROVIDES SOFTWARE "AS IS" WITHOUT WARRANTY OF ANY KIND,EITHER EXPRESSED OR IMPLIED,INCLUDING,BUT NOT LIMITED TO,THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF SOFTWARE IS WITH USER. SHOULD SOFTWARE PROVE DEFECTIVE, USER SHALL ASSUME THE COST OF ALL NECESSARY SERVICING, REPAIR OR CORRECTION.

IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING WILL BRNO UNIVERSITY OF TECHNOLOGY BE LIABLE FOR DAMAGES, INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE USE OR INABILITY TO USE SOFTWARE (INCLUDING BUT NOT LIMITED TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD PARTIES OR A FAILURE OF SOFTWARE TO OPERATE WITH ANY OTHER PROGRAMS).

Final provisions:
Any provision of this licence agreement that is prohibited, unenforceable, or not authorized in any jurisdiction shall, as to such jurisdiction, be ineffective to the extent of such prohibition, unenforceability, or non-authorization without invalidating or affecting the remaining provisions.

This licence agreement provides in essentials the same extent of rights as the terms of GNU GPL version 2 and Software fulfils the requirements of Open Source software.

This agreement is governed by law of the Czech Republic. In case of a dispute, the jurisdiction shall be that of courts in the Czech Republic.
By installing, copying or other use of Software User declares he/she has read this terms and conditions, understands them and his/her use of Software is a demonstration of his/her free will absent of any duress.
